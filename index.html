<!DOCTYPE html>
<html lang="en">

<head>
	<meta charset="utf-8">
	<title>African Cities</title>
	<script type="text/javascript" src="d3.js"></script>
	<style type="text/css">
		/* No style rules here yet */

	</style>
</head>

<body>
	<script type="text/javascript">
		//Width and height
		var w = 800;
		var h = 800;

		//Define map projection
		var projection = d3.geoOrthographic()
			.translate([w / 2, h / 2])
			.scale([500]);

		//Define path generator
		var path = d3.geoPath()
			.projection(projection);

		//For converting Dates to strings
		var formatYear = d3.timeFormat("%Y");
		
		//Number formatting for population values
		var formatAsThousands = d3.format(",");  //e.g. converts 123456 to "123,456"

		//Create SVG element
		var svg = d3.select("body")
			.append("svg")
			.attr("width", w)
			.attr("height", h);

		//Function for converting CSV values from strings to Dates and numbers
		var formatData = function(dataArray) {
			return dataArray.map(function(row) {
				return {
					city: row["city"],
					country: row["country"],
					lon: row["lon"],
					lat: row["lat"],
					population: {
						"1950": row["1950"] * 1000,
						"1955": row["1955"] * 1000,
						"1960": row["1960"] * 1000,
						"1965": row["1965"] * 1000,
						"1970": row["1970"] * 1000,
						"1975": row["1975"] * 1000,
						"1980": row["1980"] * 1000,
						"1985": row["1985"] * 1000,
						"1990": row["1990"] * 1000,
						"1995": row["1995"] * 1000,
						"2000": row["2000"] * 1000,
						"2005": row["2005"] * 1000,
						"2010": row["2010"] * 1000,
						"2015": row["2015"] * 1000,
						"2020": row["2020"] * 1000,
						"2025": row["2025"] * 1000,
						"2030": row["2030"] * 1000
					}

				};
			});

			//Log data to check it loaded right
			console.log(nested);
			return nested;

		}

		//Load in data
		d3.json("africa.json", function(json) {

			//Bind data and create one path per GeoJSON feature
			svg.selectAll("path")
				.data(json.features)
				.enter()
				.append("path")
				.attr("d", path)
				.style("fill", "white")
				.style("stroke", "grey");

			d3.csv("africadata.csv", function(data) {

				nested = formatData(data);

				svg.selectAll("circle")
					.data(nested)
					.enter()
					.append("circle")
					.attr("cx", function(d) {
						return projection([d.lon, d.lat])[0];
					})
					.attr("cy", function(d) {
						return projection([d.lon, d.lat])[1];
					})
					.attr("r", function(d) {
						return Math.sqrt(parseInt(d.population[1950])* 0.0008);
					})
					.style("fill", "gray")
					.style("opacity", 0.75)
					.append("title") //Simple tooltip
					.text(function(d) {
						return d.city + ": Pop. " + formatAsThousands(d.population[1950]);
					});

			});
		});

	</script>
</body>

</html>
